<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>í¬ì¸íŠ¸ ì€í–‰ ì‹œìŠ¤í…œ (Firebase ì—°ë™)</title>
  <style>
    body{font-family:"Pretendard",sans-serif;text-align:center;padding:30px;background:linear-gradient(135deg,#a8edea,#fed6e3);color:#333;}
    input,button{padding:10px 14px;margin:6px;border-radius:8px;border:none;font-size:15px;}
    button{cursor:pointer;background:#6c63ff;color:#fff;transition:background 0.3s;}
    button:hover{background:#514bff;}
    .box{background:#fff;padding:25px 40px;border-radius:14px;display:inline-block;margin-top:20px;box-shadow:0 4px 15px rgba(0,0,0,0.1);}
  </style>
</head>
<body>
  <h1>í¬ì¸íŠ¸ ì€í–‰ ì‹œìŠ¤í…œ</h1>
  <div id="login">
    <p>ë‹‰ë„¤ì„ ì…ë ¥:</p>
    <input type="text" id="nicknameInput" placeholder="ì˜ˆ: ì„ì£¼" />
    <button id="nicknameBtn">ì‹œì‘</button>
  </div>

  <div id="game" class="box" style="display:none;">
    <h2 id="nick">ë‹‰ë„¤ì„: </h2>
    <p>ë³´ìœ  í¬ì¸íŠ¸: <span id="points">0</span> P</p>
    <p>ì€í–‰ ì”ê³ : <span id="bank">0</span> P</p>

    <input type="number" id="amount" placeholder="ê¸ˆì•¡ ì…ë ¥" />
    <br/>
    <button id="deposit">ì˜ˆê¸ˆ</button>
    <button id="withdraw">ì¸ì¶œ</button>
    <br/><br/>
    <button id="earn">+10 í¬ì¸íŠ¸ ì–»ê¸°</button>
    <br/><br/>
    <input type="number" id="rate" value="1.0" step="0.1" style="width:70px;"> % /ë¶„ (ì´ììœ¨)
    <br/><br/>
    <div id="log" style="text-align:left;height:120px;overflow:auto;padding:8px;background:#eee;border-radius:6px;"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, set, get, update, push } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    // âœ… ì‹¤ì œ í”„ë¡œì íŠ¸ ì •ë³´ (clicker-dc943)
    const firebaseConfig = {
      apiKey: "AIzaSyC-MtgjlEwQ7AX1Wl3OrnCwcZMQK1WnUUs",
      authDomain: "clicker-dc943.firebaseapp.com",
      databaseURL: "https://clicker-dc943-default-rtdb.asia-southeast1.firebasedatabase.app/",
      projectId: "clicker-dc943",
      storageBucket: "clicker-dc943.appspot.com",
      messagingSenderId: "260210837373",
      appId: "1:260210837373:web:f0ae35be236cd52edb0f62"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth();

    const state = {
      uid: null,
      nickname: null,
      points: 0,
      bank: 0,
      ratePerMinute: 1.0,
      lastTimestamp: Date.now()
    };

    const el = id => document.getElementById(id);
    const logEl = el("log");
    function log(msg){
      const t = new Date().toLocaleTimeString();
      logEl.innerHTML = `[${t}] ${msg}<br>` + logEl.innerHTML;
    }

    // ğŸ” ìµëª… ë¡œê·¸ì¸
    signInAnonymously(auth).catch(err=>console.error(err));
    onAuthStateChanged(auth, user => {
      if(user){
        state.uid = user.uid;
        log("Firebase ë¡œê·¸ì¸ ì™„ë£Œ: " + state.uid);
      }
    });

    // ë‹‰ë„¤ì„ ì„¤ì •
    el("nicknameBtn").addEventListener("click", async () => {
      const name = el("nicknameInput").value.trim();
      if(!name){ alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
      state.nickname = name;

      const userRef = ref(db, `players/${state.uid}`);
      const snap = await get(userRef);
      if(!snap.exists()){
        await set(userRef, {
          nickname: name,
          points: 0,
          bank: 0,
          ratePerMinute: 1.0,
          lastTimestamp: Date.now()
        });
        log("ìƒˆ í”Œë ˆì´ì–´ ìƒì„±ë¨.");
      } else {
        const data = snap.val();
        Object.assign(state, data);
        log("ê¸°ì¡´ í”Œë ˆì´ì–´ ë°ì´í„° ë¶ˆëŸ¬ì˜´.");
      }

      el("login").style.display = "none";
      el("game").style.display = "block";
      el("nick").textContent = `ë‹‰ë„¤ì„: ${name}`;
      render();
    });

    function render(){
      el("points").textContent = Math.floor(state.points);
      el("bank").textContent = Math.floor(state.bank);
      el("rate").value = state.ratePerMinute;
    }

    async function saveData(){
      await update(ref(db, `players/${state.uid}`), {
        nickname: state.nickname,
        points: state.points,
        bank: state.bank,
        ratePerMinute: state.ratePerMinute,
        lastTimestamp: Date.now()
      });
    }

    async function recordHistory(type, amt){
      await push(ref(db, `players/${state.uid}/history`), {
        time: new Date().toISOString(),
        type, amount: amt
      });
    }

    el("earn").addEventListener("click", async () => {
      state.points += 10;
      render(); await saveData(); await recordHistory("earn", 10);
      log("+10 í¬ì¸íŠ¸ íšë“");
    });

    el("deposit").addEventListener("click", async () => {
      const amt = Number(el("amount").value);
      if(!amt || amt <= 0){ log("ê¸ˆì•¡ ì…ë ¥ í•„ìš”"); return; }
      if(state.points < amt){ log("í¬ì¸íŠ¸ ë¶€ì¡±"); return; }
      state.points -= amt; state.bank += amt;
      render(); await saveData(); await recordHistory("deposit", amt);
      log(`${amt}P ì˜ˆê¸ˆ`);
    });

    el("withdraw").addEventListener("click", async () => {
      const amt = Number(el("amount").value);
      if(!amt || amt <= 0){ log("ê¸ˆì•¡ ì…ë ¥ í•„ìš”"); return; }
      if(state.bank < amt){ log("ì€í–‰ ì”ê³  ë¶€ì¡±"); return; }
      state.bank -= amt; state.points += amt;
      render(); await saveData(); await recordHistory("withdraw", amt);
      log(`${amt}P ì¸ì¶œ`);
    });

    el("rate").addEventListener("change", async () => {
      state.ratePerMinute = Number(el("rate").value);
      render(); await saveData();
      log(`ì´ììœ¨ ë³€ê²½: ${state.ratePerMinute}%/ë¶„`);
    });

    // ğŸ’° ìë™ ì´ì (5ì´ˆë§ˆë‹¤)
    setInterval(async () => {
      if(!state.uid) return;
      const now = Date.now();
      const elapsedSec = Math.floor((now - state.lastTimestamp) / 1000);
      if(elapsedSec > 0 && state.bank > 0){
        const rate = state.ratePerMinute / 100;
        const perSec = Math.pow(1 + rate, 1/60) - 1;
        const newBank = Math.floor(state.bank * Math.pow(1 + perSec, elapsedSec));
        const diff = newBank - state.bank;
        if(diff > 0){
          state.bank = newBank;
          log(`ì´ì ë°œìƒ: +${diff}P`);
        }
      }
      state.lastTimestamp = now;
      await saveData();
      render();
    }, 5000);
  </script>
</body>
</html>
